---
title: "Wait Time Analysis"
output: 
 html_document: 
    theme: spacelab
    df_print: paged
    toc: yes
---

## Define the wait time

There are two variables related: 

  * `ADT_ARRIVAL_DTTM` describes the moment a patient arrives the ED
  * `IN_DTTM` describes the moment a patient gets into another particular place in ED (for example, transfer from lodge to bed)

We define the wait time as follows:

**The time between the patient arrived at ED and the first event that patient moved to another place.** *In other words, difference between `ADT_ARRIVAL_DTTM` and the earliest `IN_DTTM`*

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.align = 'center',
                      comment = NA)
library(tidyverse)
library(lubridate)
library(stringr)
library(DT)
```

```{r include=FALSE}
encounters <- read_csv("/srv/rsdata/UCSD_F_ED_ENCOUNTERS.csv",
                       col_types = cols(ADT_ARRIVAL_DATE = col_date(format = "%m/%d/%Y"),
                                        ADT_ARRIVAL_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        ED_DEPARTURE_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        ED_DISPOSITION_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        EMERGENCY_ADMISSION_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        HOSPITAL_ADMISSION_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        HOSPITAL_DISCHARGE_DATE = col_date(format = "%m/%d/%Y"),
                                        HOSPITAL_DISCHARGE_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                        UPDATE_DATE = col_datetime(format = "%m/%d/%Y %H:%M")))

encounters <- bind_rows(
  encounters %>% filter(ED_OR_UC_DEPARTMENT == 'EMERGENCY'),
  encounters %>% filter(ED_OR_UC_DEPARTMENT == 'Kiswahili') %>% 
    mutate(LANGUAGE = paste(LANGUAGE, ED_OR_UC_DEPARTMENT, sep = '/'),
           ED_OR_UC_DEPARTMENT = BEHAVIORAL_DASHB,
           BEHAVIORAL_DASHB = as.integer(X77)),
  encounters %>% filter(ED_OR_UC_DEPARTMENT == 'English') %>% 
    mutate(FINANCIAL_CLASS_NAME = PATIENT_SEX,
           PATIENT_SEX = LANGUAGE,
           LANGUAGE = ED_OR_UC_DEPARTMENT,
           ED_OR_UC_DEPARTMENT = BEHAVIORAL_DASHB,
           BEHAVIORAL_DASHB = as.integer(X77))
) %>% 
  select(-X77)

```


```{r includd=FALSE}
adtLocation <- read_delim("/srv/rsdata/UCSD_ED_ADT_LOCATION.csv",
                          ";",
                          escape_double = FALSE,
                          col_types = cols(ADT_ARRIVAL_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                           IN_DTTM = col_datetime(format = "%m/%d/%Y %H:%M"),
                                           OUT_DTTM = col_datetime(format = "%m/%d/%Y %H:%M")),
                          trim_ws = TRUE)

df <- adtLocation %>% 
  left_join(encounters, by = c('PAT_ENC_CSN_ID', 'ADT_ARRIVAL_DTTM', 'LAST_DEPARTMENT_ID')) %>% 
  select(PAT_ENC_CSN_ID, 
         ADT_ARRIVAL_DTTM, 
         IN_DTTM,
         OUT_DTTM,
         BEHAVIORAL_DASHB,
         AGE_AT_ARRIVAL_MONTHS,
         ACUITY_LEVEL_C,
         FIRST_CHIEF_COMPLAINT) %>% 
  filter(ACUITY_LEVEL_C != 'null') %>% 
  mutate(ADT_WEEKDAYS = factor(wday(ADT_ARRIVAL_DTTM),
                               labels = c('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday')),
         ADT_MONTH = factor(month(ADT_ARRIVAL_DTTM),
                            labels = c('January','February','March','April','May','June','July','August','September','October','November','December')),
         ACUITY_LEVEL_C = factor(ifelse(ACUITY_LEVEL_C %in% c('1','2','3','4','5'), ACUITY_LEVEL_C, 'Others'),
                                 levels = c('Others','5','4','3','2','1'),
                                 ordered = T),
         ADT_YEAR = factor(year(ADT_ARRIVAL_DTTM)),
         ADT_HOUR = factor(hour(ADT_ARRIVAL_DTTM)),
         BEHAVIORAL_DASHB = factor(BEHAVIORAL_DASHB)) 

wTime <- df %>% 
  group_by(PAT_ENC_CSN_ID, ADT_MONTH, ADT_WEEKDAYS, ACUITY_LEVEL_C, ADT_YEAR, BEHAVIORAL_DASHB) %>% 
  mutate(wait = min(IN_DTTM) - ADT_ARRIVAL_DTTM) %>% 
  summarise(wait = mean(wait)) %>% 
  ungroup() %>% 
  mutate(wait = as.numeric(wait) / 60)
```

```{r}
less0 <- df %>% filter(PAT_ENC_CSN_ID %in% wTime[which(wTime$wait < 0),]$PAT_ENC_CSN_ID)

```

After check we found there are `r nrow(less0)` observations had a wait time that was less than 0.

```{r}
datatable(less0, options = list(autoWidth =  TRUE, scrollX = TRUE))

```

We think it was because the EPIC system's error.

```{r ,fig.width = 8,fig.height = 16}
avgWait_wday <- wTime %>% 
  filter(wait >= 0) %>% 
  group_by(ADT_YEAR, ADT_MONTH, ADT_WEEKDAYS) %>% 
  summarise(avg = mean(wait)) %>% 
  ggplot(aes(x = ADT_WEEKDAYS, y = avg, fill = ADT_YEAR)) +
  geom_col(position = 'dodge') +
  facet_grid(ADT_MONTH~.) +
  theme_bw() +
  scale_fill_brewer(palette = 'Spectral') +
  ggtitle('Average Wait Time 2014 - 2018') +
  theme(axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        strip.text = element_text(size = 4),
        legend.position = 'bottom',
        legend.title = element_blank(),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.5,'cm')) +
  labs(x = NULL, y = NULL)
avgWait_wday
```

From the graph shown above, we observe abnormality starting from September, 2017. The average wait time increased significantly across the week. (We believe we need to further validate with the ED). 

```{r}
avg <- wTime %>% 
  filter(wait >= 0) %>% 
  group_by(ADT_YEAR) %>% 
  summarise(avg = mean(wait))
```

Besides that, 

  * average wait time is for year 2014 is `r round(avg$avg[1], 2)` minutes.
  * average wait time is for year 2015 is `r round(avg$avg[2], 2)` minutes.
  * average wait time is for year 2016 is `r round(avg$avg[3], 2)` minutes.
  * average wait time is for year 2017 is `r round(avg$avg[4], 2)` minutes.
  * average wait time is for year 2018 is `r round(avg$avg[5], 2)` minutes.
  
  
## Average Wait Time for Different Acuities

```{r fig.height=16, fig.width=8}
avgWait_acuity <- wTime %>% 
  filter(wait >= 0) %>% 
  group_by(ACUITY_LEVEL_C, ADT_YEAR) %>% 
  summarise(avg = mean(wait)) %>% 
  ggplot(aes(x = ACUITY_LEVEL_C, y = avg)) +
  geom_col(position = 'dodge') +
  geom_text(aes(x = ACUITY_LEVEL_C, y = avg, label = round(avg, 2)), vjust = 1.5, color = 'white') +
  facet_grid(ADT_YEAR~.) +
  theme_bw() +
  scale_fill_brewer(palette = 'Spectral') +
  ggtitle('Average Wait Time 2014 - 2018') +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank(),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.5,'cm')) +
  labs(x = NULL, y = NULL)
avgWait_acuity
```

The average wait time follows the common sense, that patients with high acuity get treatment first and fast because of high priority.


## Chief Complaints and Wait Time

The top 15 first cheif complaints are as follows:

```{r}
topCC <- df %>%
  group_by(FIRST_CHIEF_COMPLAINT) %>% summarise(n = n()) %>%
  arrange(desc(n)) %>% ungroup() %>% slice(1:15)

datatable(topCC, options = list(autoWidth = TRUE))
```

```{r, fig.height=8, fig.width=8}

wTime_CC <- df %>% 
  filter(FIRST_CHIEF_COMPLAINT %in% topCC$FIRST_CHIEF_COMPLAINT) %>% 
  group_by(ADT_MONTH, ADT_WEEKDAYS, ACUITY_LEVEL_C, ADT_YEAR, FIRST_CHIEF_COMPLAINT) %>% 
  mutate(wait = min(IN_DTTM) - ADT_ARRIVAL_DTTM) %>% 
  mutate(wait = as.numeric(wait) / 60) %>% 
  filter(wait >= 0) %>% 
  group_by(FIRST_CHIEF_COMPLAINT) %>%
  summarise(avg = mean(wait)) %>% 
  ungroup()



df %>% 
  group_by(ADT_MONTH, ADT_YEAR, FIRST_CHIEF_COMPLAINT) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>% 
  slice(1:5) %>% ungroup() %>% 
  ggplot(aes(x = ADT_MONTH, y = n)) +
  geom_point(aes(color = FIRST_CHIEF_COMPLAINT), alpha = 0.5) +
  theme_bw() +
  facet_grid(ADT_YEAR~.) +
  scale_color_brewer(palette = 'Dark2')

df %>% 
  filter(FIRST_CHIEF_COMPLAINT %in% topCC$FIRST_CHIEF_COMPLAINT) %>% 
  group_by(ADT_MONTH,ACUITY_LEVEL_C, ADT_YEAR, FIRST_CHIEF_COMPLAINT) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = ADT_MONTH, y = n)) +
  geom_point(aes(color = FIRST_CHIEF_COMPLAINT, size = n)) +
  # geom_col(position = 'dodge') +
  # geom_text(aes(x = ADT_MONTH, y = n, label = round(n, 2)), vjust = 1.5, color = 'white') +
  theme_bw() +
  # scale_fill_brewer(palette = 'Spectral') +
  ggtitle('Average Wait Time 2014 - 2018') +
  theme(axis.text.x = element_text(angle = 90, size = 12, hjust = 1),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank(),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.5,'cm')) +
  labs(x = NULL, y = NULL) +
  facet_grid(ADT_YEAR~.)


avgWait_CC <- wTime_CC %>% 
  mutate(FIRST_CHIEF_COMPLAINT = reorder(FIRST_CHIEF_COMPLAINT, avg)) %>% 
  ggplot(aes(x = FIRST_CHIEF_COMPLAINT, y = avg)) +
  geom_col(position = 'dodge') +
  geom_text(aes(x = FIRST_CHIEF_COMPLAINT, y = avg, label = round(avg, 2)), vjust = 1.5, color = 'white') +
  theme_bw() +
  # scale_fill_brewer(palette = 'Spectral') +
  ggtitle('Average Wait Time 2014 - 2018') +
  theme(axis.text.x = element_text(angle = 90, size = 12, hjust = 1),
        axis.text.y = element_text(size = 8),
        strip.text = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank(),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.5,'cm')) +
  labs(x = NULL, y = NULL)
avgWait_CC
```
